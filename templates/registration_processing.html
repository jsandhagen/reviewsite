<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Importing Steam Library - PeerPulse</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      }
      .processing-container {
        max-width: 600px;
        width: 100%;
        padding: 48px;
        background: #1a1a1a;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        border: 1px solid #333;
        text-align: center;
      }
      .logo h1 {
        margin: 0 0 16px 0;
        font-size: 36px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .steam-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 24px;
        filter: invert(0.7);
      }
      .status-message {
        font-size: 18px;
        color: #fff;
        margin-bottom: 12px;
        font-weight: 600;
      }
      .detail-message {
        font-size: 14px;
        color: #888;
        margin-bottom: 32px;
        min-height: 20px;
      }
      .progress-container {
        width: 100%;
        background: #0f0f0f;
        border-radius: 8px;
        height: 40px;
        overflow: hidden;
        margin-bottom: 16px;
        border: 1px solid #444;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
      }
      .progress-stats {
        color: #aaa;
        font-size: 14px;
        margin-bottom: 24px;
      }
      .spinner {
        width: 48px;
        height: 48px;
        margin: 0 auto 24px;
        border: 4px solid #333;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .complete-message {
        display: none;
        padding: 20px;
        background: #1f4f3f;
        border: 1px solid #2d6b4f;
        border-radius: 8px;
        margin-top: 24px;
      }
      .complete-message.show {
        display: block;
      }
      .error-message {
        display: none;
        padding: 20px;
        background: #6e1f1f;
        border: 1px solid #8b2e2e;
        border-radius: 8px;
        margin-top: 24px;
        color: #ffb3b3;
      }
      .error-message.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="processing-container">
      <div class="logo">
        <h1>PeerPulse</h1>
      </div>

      <img src="/static/steam.svg" alt="Steam" class="steam-icon">

      <div class="spinner" id="spinner"></div>

      <div class="status-message" id="statusMessage">Preparing Steam import...</div>
      <div class="detail-message" id="detailMessage">Please wait while we fetch your Steam library</div>

      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%;">
          <span id="progressText">0%</span>
        </div>
      </div>

      <div class="progress-stats" id="progressStats"></div>

      <div class="complete-message" id="completeMessage">
        <strong>Import Complete!</strong><br>
        Redirecting to your profile...
      </div>

      <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
      let checkInterval;
      let redirectTimeout;

      function checkProgress() {
        fetch('/api/import_progress')
          .then(response => response.json())
          .then(data => {
            const statusEl = document.getElementById('statusMessage');
            const detailEl = document.getElementById('detailMessage');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressStats = document.getElementById('progressStats');
            const spinner = document.getElementById('spinner');
            const completeMessage = document.getElementById('completeMessage');
            const errorMessage = document.getElementById('errorMessage');

            if (data.status === 'starting') {
              statusEl.textContent = 'Starting import...';
              detailEl.textContent = data.message || 'Fetching Steam library...';
            } else if (data.status === 'importing') {
              spinner.style.display = 'none';
              progressContainer.style.display = 'block';
              statusEl.textContent = 'Importing Games';
              detailEl.textContent = data.message || '';

              const percentage = Math.round((data.current / data.total) * 100);
              progressBar.style.width = percentage + '%';
              progressText.textContent = percentage + '%';
              progressStats.textContent = `${data.imported} of ${data.total} games imported (${data.current}/${data.total} processed)`;
            } else if (data.status === 'complete') {
              spinner.style.display = 'none';
              progressContainer.style.display = 'block';
              progressBar.style.width = '100%';
              progressText.textContent = '100%';
              statusEl.textContent = 'Import Complete!';
              detailEl.textContent = data.message || '';
              progressStats.textContent = `Successfully imported ${data.imported} games`;
              completeMessage.classList.add('show');

              clearInterval(checkInterval);

              // Redirect after 2 seconds
              redirectTimeout = setTimeout(() => {
                window.location.href = '/';
              }, 2000);
            } else if (data.status === 'error') {
              spinner.style.display = 'none';
              statusEl.textContent = 'Import Failed';
              detailEl.textContent = '';
              errorMessage.textContent = data.message || 'An error occurred during import';
              errorMessage.classList.add('show');

              clearInterval(checkInterval);

              // Redirect after 5 seconds even on error
              redirectTimeout = setTimeout(() => {
                window.location.href = '/';
              }, 5000);
            } else if (data.status === 'not_found') {
              // No import in progress, redirect to home
              clearInterval(checkInterval);
              window.location.href = '/';
            }
          })
          .catch(error => {
            console.error('Error checking progress:', error);
          });
      }

      // Check progress immediately
      checkProgress();

      // Then check every 500ms
      checkInterval = setInterval(checkProgress, 500);

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        clearInterval(checkInterval);
        if (redirectTimeout) clearTimeout(redirectTimeout);
      });
    </script>
  </body>
</html>
